{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with {{ other_user.username }}</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #0084ff; color: white; padding: 0.8rem 1.2rem; display: flex; align-items: center; gap: 0.8rem; flex-shrink: 0; }
        .header a { color: white; text-decoration: none; font-size: 1.2rem; }
        .header .avatar { width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .header .info .name { font-weight: bold; }
        .header .info .status { font-size: 0.8rem; opacity: 0.85; }
        .chat-box { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.4rem; }
        .msg { max-width: 70%; padding: 0.5rem 0.8rem; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; position: relative; word-break: break-word; }
        .msg.sent { background: #0084ff; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .msg.received { background: white; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg .meta { font-size: 0.72rem; margin-top: 0.2rem; display: flex; align-items: center; gap: 0.3rem; }
        .msg.sent .meta { color: rgba(255,255,255,0.7); justify-content: flex-end; }
        .msg.received .meta { color: #aaa; }
        .tick { font-size: 0.8rem; }
        .tick.read { color: #53bdeb; }
        .input-area { background: white; padding: 0.8rem 1rem; display: flex; gap: 0.6rem; border-top: 1px solid #e0e0e0; flex-shrink: 0; }
        .input-area input { flex: 1; padding: 0.6rem 0.9rem; border: 1px solid #ddd; border-radius: 20px; font-size: 0.95rem; outline: none; }
        .input-area input:focus { border-color: #0084ff; }
        .input-area button { background: #0084ff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .input-area button:hover { background: #0070d8; }
        /* Delete context menu */
        .msg-menu-btn { display: none; position: absolute; top: 3px; right: 6px; background: none; border: none; cursor: pointer; font-size: 0.8rem; padding: 1px 3px; line-height: 1; border-radius: 3px; }
        .msg.sent .msg-menu-btn { color: rgba(255,255,255,0.8); }
        .msg.received .msg-menu-btn { color: #bbb; }
        .msg:hover .msg-menu-btn { display: block; }
        .msg-menu { display: none; position: absolute; top: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.18); min-width: 175px; z-index: 100; overflow: hidden; }
        .msg.sent .msg-menu { right: 2px; }
        .msg.received .msg-menu { left: 2px; }
        .msg-menu.show { display: block; }
        .msg-menu button { display: block; width: 100%; text-align: left; padding: 0.55rem 1rem; background: none; border: none; cursor: pointer; font-size: 0.88rem; color: #e53935; }
        .msg-menu button:hover { background: #fef2f2; }
        .msg.is-deleted .msg-content { font-style: italic; opacity: 0.6; }
    </style>
</head>
<body>

<div class="header">
    <a href="{% url 'user_list' %}">&#8592;</a>
    <div class="avatar">{{ other_user.username|first|upper }}</div>
    <div class="info">
        <div class="name">{{ other_user.username }}</div>
        <div class="status"
             data-is-online="{% if other_user.is_online %}true{% else %}false{% endif %}"
             data-last-seen-iso="{% if other_user.last_seen %}{{ other_user.last_seen.isoformat }}{% endif %}">
            {{ other_user.last_seen_display }}
        </div>
    </div>
</div>

<div class="chat-box" id="chatBox">
    {% for msg in messages %}
    <div class="msg {% if msg.is_mine %}sent{% else %}received{% endif %}{% if msg.is_deleted %} is-deleted{% endif %}" data-id="{{ msg.id }}">
        {% if not msg.is_deleted %}
        <button class="msg-menu-btn">&#8964;</button>
        <div class="msg-menu">
            <button data-msg-id="{{ msg.id }}" data-delete-type="for_me">Delete for Me</button>
            {% if msg.is_mine %}<button data-msg-id="{{ msg.id }}" data-delete-type="for_everyone">Delete for Everyone</button>{% endif %}
        </div>
        {% endif %}
        <span class="msg-content">{% if msg.is_deleted %}ðŸš« This message was deleted{% else %}{{ msg.content }}{% endif %}</span>
        <div class="meta">
            <span class="msg-time" data-iso="{{ msg.timestamp.isoformat }}"></span>
            {% if msg.is_mine and not msg.is_deleted %}
            <span class="tick {% if msg.is_read %}read{% endif %}">
                {% if msg.is_read %}&#10003;&#10003;{% else %}&#10003;{% endif %}
            </span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<div class="input-area">
    <input type="text" id="msgInput" placeholder="Type a message..." autocomplete="off">
    <button id="sendBtn">&#9658;</button>
</div>

<script>
    window.CHAT_CONFIG = {
        roomName: "{{ room_name }}",
        currentUserId: {{ request.user.id }},
        otherUserId: {{ other_user.id }},
    };
</script>
<script src="{% static 'js/utils.js' %}"></script>
<script src="{% static 'js/chat.js' %}"></script>
</body>
</html>
